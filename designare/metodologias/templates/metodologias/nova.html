{% extends 'designare/esqueleto.html' %}
{% block body %}
<div class="container">
    <div class="row m-t-3">
        <div class="col-md-1 offset-md-11">
            <div class="btn-group">
                <button
                    type="button"
                    class="btn btn-secondary border-square"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                    data-tooltip="tooltip" data-placement="top" title="Menu"
                >
                    <i class="fa fa-bars" aria-hidden="true"></i>
                </button>
                <div class="dropdown-menu border-square">
                    <a class="dropdown-item" href="/">
                        <i class="fa fa-home" aria-hidden="true"></i>&nbsp;Início
                    </a>
                    <a class="dropdown-item" href="/metodologias/">
                        <i class="fa fa-database" aria-hidden="true"></i>&nbsp;Metodologias
                    </a>
                    <a class="dropdown-item" href="/projetos/">
                        <i class="fa fa-briefcase" aria-hidden="true"></i>&nbsp;Projetos
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <h1 align="center">Designare</h1>
    </div>
    <div class="row m-y-1">
        <h2 align="center">{{ titulo_da_pagina }}</h2>
    </div>
    <div class="row m-y-2 {% if metodologia %} hidden {% endif %}" align="center" id="div-form-metodologia">
        <div class="col-md-6 offset-md-3">
            <form class="form-inline" id="form-metodologia" name="form_metodologia">
                {% csrf_token %}
                <input 
                    type="hidden" name="metodologia-id" id="input-metodologia-id" 
                    {% if metodologia %}
                        value="{{ metodologia.id }}"
                    {% endif %}
                />
                <div class="form-group" id="div-input-metodologia-nome">
                    <label class="sr-only" for="input-metodologia-nome">
                        <b>Nome</b>&nbsp;
                    </label>
                    <input name="nome" 
                        type="text"
                        class="form-control border-square"
                        placeholder="Nome da Metodologia"
                        id="input-metodologia-nome"
                        data-tooltip="tooltip" data-placement="bottom"
                        title="Forneça um nome para a Metodologia!"
                        {% if metodologia %}
                            value="{{ metodologia.nome }}"
                        {% endif %}
                    >
                    <button class="btn btn-danger border-square" id="btn-cancela-metodologia">
                        <i class="fa fa-times"></i>
                    </button>
                    <button class="btn btn-success border-square" id="btn-nova-metodologia">
                        <i class="fa fa-check"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div
        {% if metodologia %}
            class="row m-y-1"                    
        {% else %}
            class="row m-y-1 hidden" 
        {% endif %} 
        id="div-metodologia-nome"
    >
            <h2 align="center">
                <span id="metodologia-nome">
                    {% if metodologia %}
                        {{ metodologia.nome }}
                    {% endif %}
                </span>
                <button 
                    class="btn btn-secondary border-square" id="btn-edit-metodologia"
                    data-tooltip="tooltip" data-placement="top"
                    title="Editar nome"
                >
                    <i class="fa fa-pencil"></i>
                </button>
            </h2>
        </div>
    <div class="row">
        <hr>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-md-3" style="position: relative;">
            <div class="list-group" id="div-menu-etapas" style="position: fixed;">
                <a href="#Cadastrar_Nova_Etapa" class="list-group-item list-group-item-action list-group-item-info"
                    id="li-menu-primeiro-item">
                    Nenhuma etapa adicionada
                </a>
                <!-- Inserir demais links de etapas aqui -->
            </div>
        </div>
        <div class="col-md-9">
            <div class="row col-md-11 offset-md-1" id="div-listagem-etapas">
                <!-- Inserir etapas aqui -->
            </div>
            <div class="row">
                <div class="row">
                    <div class="col-md-6 offset-md-3">
                        <a id="Cadastrar_Nova_Etapa"></a>
                        <div class="row">
                            <br>
                            <form id="form-etapa" name="form_etapa">
                                <fieldset id="fieldset-nova-etapa">
                                    {% csrf_token %}
                                    <div class="form-group" id="div-input-etapa-nome">
                                        <label>
                                            <b>Nome</b>&nbsp;
                                            <i
                                                class="fa fa-asterisk"  data-tooltip="tooltip" data-placement="top"
                                                title="Este campo é obrigatório!"
                                            ></i>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-addon border-square">
                                                <i class="fa fa-tag"></i>
                                            </span>
                                            <input name="nome" 
                                                type="text"
                                                class="form-control border-square"
                                                placeholder="Nome da Etapa"
                                                id="input-etapa-nome" 
                                            >
                                        </div>
                                        <div class="form-control-feedback" id="div-etapa-nome-feedback"></div>
                                    </div>
                                    <label><b>Descrição</b></label>
                                    <div class="input-group">
                                        <span class="input-group-addon border-square">
                                            <i class="fa fa-info"></i>
                                        </span>
                                        <textarea name="descricao" 
                                            class="form-control border-square"
                                            placeholder="Descrição da Etapa"
                                            rows="5" maxlength="300"
                                            id="input-etapa-descricao"
                                        ></textarea>
                                    </div>
                                    <p class="form-text text-muted">
                                        Forneça uma descrição para auxiliar membros da equipe a identificar o propósito de cada etapa ou facilitar o aprendizado de novos membros. 
                                    </p>
                                    <br>
                                    <div align="center">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-secondary" id="btn-nova-etapa">
                                                Cadastrar Etapa
                                            </button>
                                        </div>
                                    </div>
                                </fieldset>                                
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block javascript_functions %}
$(document).ready(function(){
    /* Verifica se metodologia tem nome definido */
    if($("#div-metodologia-nome").hasClass("hidden")){
        /* Se metodologia não tem nome definido (não existe)*/
        /* Desabilita o formulário de cadastro de etapas */
        $("#fieldset-nova-etapa").prop("disabled",true)
        /* Requisita foco para o campo de nome da metodologia */
        $("#input-metodologia-nome").focus();
        /* Exibe tooltip do campo */
        $("#input-metodologia-nome").tooltip('show');
    }
    /* Previne a submissão do formulário */
    $("#form-metodologia").submit(function(){
        event.preventDefault();
    });

    /* Ação de cadastro de metodologia (definição do nome) */
    $("#btn-nova-metodologia").click(function(){
        event.preventDefault();
        $("#div-input-metodologia-nome").toggleClass("has-danger",false);
        $("#input-metodologia-nome").toggleClass("form-control-danger",false);
        nome = $("#input-metodologia-nome").val();
        idm = $("#input-metodologia-id").val();
        if (idm == "") {
            endereco = "{% url 'metodologias:cadastrar_metodologia' %}";
        } else {
            endereco = "/metodologias/" + idm + "/atualizar-nome/";
        }
        if(!nome){
            $("#div-input-metodologia-nome").toggleClass("has-danger",true);
            $("#input-metodologia-nome").toggleClass("form-control-danger",true);
        }
        else {
            /* Realiza a requisição ajax para cadastro */
            $.ajax({
                type    : "POST",
                url     : endereco,
                data    : { 'nome' : nome,
                            'csrfmiddlewaretoken' : document.form_metodologia.csrfmiddlewaretoken.value,
                        },
                dataType: "json",
                encode  : true,

                beforeSend: function(){
                    $('#btn-nova-metodologia').html('<i class="fa fa-circle-o-notch fa-spin fa-fw"></i>&nbsp;Processando');
                },
                success: function(data){
                    //Cria um log da data recebida no console
                    console.log(data);
                    //Verifica se a operação foi bem sucedida
                    $('#btn-nova-metodologia').html("<i class='fa fa-check'></i>");
                    if(data.sucesso)
                    {
                        $("#input-metodologia-id").val(data.metodologia_id);
                        $("#metodologia-nome").empty();
                        $("#metodologia-nome").append(nome);
                        $("#div-form-metodologia").toggleClass("hidden",true);
                        $("#div-metodologia-nome").toggleClass("hidden",false);
                        /* Habilita o formulário de cadastro de etapas */
                        $("#fieldset-nova-etapa").prop("disabled",false)
                        if(idm == ""){window.history.replaceState(null, null, "/metodologias/"+data.metodologia_id+"/")};                       
                    }
                }
            });
        }
    });

    /* Ação de edição de metodologia */
    $("#btn-edit-metodologia").click(function(){
        $("#div-metodologia-nome").toggleClass("hidden",true);
        $("#div-form-metodologia").toggleClass("hidden",false);
        /* Requisita foco para o campo de nome da metodologia */
        $("#input-metodologia-nome").focus();
        /* Exibe tooltip do campo */
        $("#input-metodologia-nome").tooltip('show');
    });

    /* Ação de cancelar edição ou cadastro de metodologia */
    $("#btn-cancela-metodologia").click(function(){
        if($("#input-metodologia-id").val() == ""){
            $(window.document.location).attr('href','/metodologias/');
        } else {
            $("#div-form-metodologia").toggleClass("hidden",true);
            $("#div-metodologia-nome").toggleClass("hidden",false);
        }
    });

    /*  */
    $("#li-menu-primeiro-item").click(function(){
        event.preventDefault();
        if($("#fieldset-nova-etapa").prop("disabled")){
            /* Requisita foco para o campo de nome da metodologia */
            $("#input-metodologia-nome").focus();
            /* Exibe tooltip do campo */
            $("#input-metodologia-nome").tooltip('show');
        } else {
            $('html, body').animate({
                scrollTop: $("#form-etapa").offset().top
            }, 1000);
            $("#input-etapa-nome").focus();
        }
    });
    $("#btn-nova-etapa").click(function(){
        /* Limpeza de estilos de validação */
        $("#div-input-etapa-nome").toggleClass("has-danger",false);
        $("#input-etapa-nome").toggleClass("form-control-danger",false);
        $("#div-etapa-nome-feedback").empty();
        /* Valor das propriedades de etapa */
        nome = $("#input-etapa-nome").val();
        descricao = $("#input-etapa-descricao").val();
        idm = $("#input-metodologia-id").val();
        endereco = "/metodologias/" + idm + "/cadastrar-etapa/";
        /* Verifica se o nome da etapa foi informado */
        if(!nome){
            /* Aplica estilos de aviso se o nome da etapa não foi informado */
            $("#div-input-etapa-nome").toggleClass("has-danger",true);
            $("#input-etapa-nome").toggleClass("form-control-danger",true);
            $("#div-etapa-nome-feedback").append("Informe o nome da etapa!");
        } else {
            /* Realiza a requisição ajax para cadastro */
            $.ajax({
                type    : "POST",
                url     : endereco,
                data    : { 'nome' : nome,
                            'descricao' : descricao, 
                            'csrfmiddlewaretoken' : document.form_etapa.csrfmiddlewaretoken.value,
                        },
                dataType: "json",
                encode  : true,

                beforeSend: function(){
                    $('#btn-nova-etapa').html('<i class="fa fa-circle-o-notch fa-spin fa-fw"></i>&nbsp;Processando');
                },
                success: function(data){
                    //Cria um log da data recebida no console
                    console.log(data);
                    //Verifica se a operação foi bem sucedida
                    $('#btn-nova-etapa').html("Cadastrar Etapa");
                    if(data.sucesso)
                    {
                        ide = data.etapa_id;

                        /* Elemento HTML que representa uma etapa */       
                        div_etapa = "<a id='etapa_"+ide+"'></a><div class='row'>"
                                        + ""
                                        + "<div class='row'>"
                                            + "<div class='card card-outline-secondary border-square unbordered'>"
                                                + "<div class='card-block'>"
                                                    + "<h3 class='card-title'>"+nome+"</h3>"
                                                    + "<blockquote class='card-blockquote'>"
                                                        + "<p>"+descricao+"</p>"
                                                    + "</blockquote>"
                                                + "</div>"
                                            + "</div>"
                                        + "</div>"
                                        + "<div class='row' id='div-etapa-"+ide+"-atividades'>"
                                            + "<!-- Inserir Atividades da Etapa aqui -->"
                                        + "</div>"
                                        + "<div class='row'>"
                                            + "<div class='row'>"
                                                + "<form "
                                                    + "class='col-md-7 offset-md-2'"
                                                    + "action='{% url 'projetos:novo' %}' method='post'"
                                                    + "enctype='multipart/form-data' id='form-nova-atividade'"
                                                + ">"
                                                    + "{% csrf_token %}"
                                                    + "<div class='form-group' id='div-input-atividade-nome'>"
                                                        + "<label><b>Nome</b></label>"
                                                        + "<div class='input-group'>"
                                                            + "<span class='input-group-addon border-square'>"
                                                                + "<i class='fa fa-tag'></i>"
                                                            + "</span>"
                                                            + "<input name='nome'" 
                                                                + "type='text'"
                                                                + "class='form-control border-square'"
                                                                + "placeholder='Nome da Atividade'"
                                                                + "id='input-atividade-nome'"
                                                            + ">"
                                                        + "</div>"
                                                    + "</div>"
                                                    + "<label><b>Descrição</b></label>"
                                                    + "<div class='input-group'>"
                                                        + "<span class='input-group-addon border-square'>"
                                                            + "<i class='fa fa-info'></i>"
                                                        + "</span>"
                                                        + "<textarea name='descricao'"
                                                            + "class='form-control border-square'"
                                                            + "placeholder='Descrição da Atividade'"
                                                            + "rows='5'"
                                                            + "id='input-atividade-descricao'"
                                                        + "></textarea>"
                                                    + "</div>"
                                                    + "<br>"
                                                    + "<div  align='center'>"
                                                        + "<div class='btn-group' role='group'>"
                                                            + "<button type='button' class='btn btn-secondary' id='btn-nova-atividade'>"
                                                                + "Cadastrar Atividade"
                                                            + "</button>"
                                                        + "</div>"
                                                    + "</div>"
                                                + "</form>"
                                            + "</div>";
                                        + "</div>"                  
                                    + "</div>"
                                    + "<div class='clearfix'>"
                                        + "<br><br><hr>"
                                    + "</div>";
                        /* Elemento HTML que representa o menu com link interno para etapa */
                        link_etapa = "<a href='#etapa_"+ide+"' class='list-group-item list-group-item-action' id='li-menu-etapa-"+nome+"'>"+nome+"</a>";
                        /* Altera o conteúdo e estilo do primeiro item do menu */
                        $("#li-menu-primeiro-item").empty();
                        $("#li-menu-primeiro-item").toggleClass("list-group-item-info",false);
                        $("#li-menu-primeiro-item").append("<i class='fa fa-plus'></i>&nbsp;Adicionar nova etapa");
                        /* Limpa os campos do formulário de cadastro de etapas */
                        $("#input-etapa-nome").val("");
                        $("#input-etapa-descricao").val("");
                        /* Insere os elementos HTML no corpo */
                        $("#div-listagem-etapas").append(div_etapa);
                        $("#div-menu-etapas").append(link_etapa);
                        /*
                        $("#li-menu-etapa-"+nome).on("click",function(){
                            //event.preventDefault();
                            //id = nome;
                            //alert(id);
                            //$('html, body').animate({
                            //    scrollTop: $("#"+nome).offset().top
                            //}, 1000);
                        });
                        */                                               
                    }
                }
            });

        }
    });
});
{% endblock %}
